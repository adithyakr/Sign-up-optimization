CREATE TABLE product (
    product_id      NUMERIC(10, 0) NOT NULL
        CONSTRAINT ppk PRIMARY KEY,
    product_name    VARCHAR2(40) NOT NULL,
    cost_per_agent  NUMERIC(10, 0) NOT NULL
);

CREATE TABLE sales (
    employee_id   NUMERIC(10, 0) NOT NULL
        CONSTRAINT spk PRIMARY KEY,
    first_name    VARCHAR2(40) NOT NULL,
    last_name     VARCHAR2(40) NOT NULL,
    phone_number  NUMERIC(10, 0),
    email         VARCHAR2(100) NOT NULL,
    region_id     NUMERIC(10, 0) NOT NULL
);

CREATE TABLE billing (
    invoice_id  NUMERIC(10, 0) NOT NULL
        CONSTRAINT bpk PRIMARY KEY,
    quote_id    NUMERIC(10, 0) NOT NULL
);

CREATE TABLE product_sales (
    sales_product_id  NUMERIC(10, 0) NOT NULL
        CONSTRAINT pspk PRIMARY KEY,
    product_id        NUMERIC(10, 0) NOT NULL,
    employee_id       NUMERIC(10, 0) NOT NULL
);

CREATE TABLE region (
    region_id  NUMBER NOT NULL
        CONSTRAINT rpk PRIMARY KEY,
    region     VARCHAR(40) NOT NULL
);

CREATE TABLE customer (
    customer_id   NUMBER NOT NULL
        CONSTRAINT cpk PRIMARY KEY,
    first_name    VARCHAR(40) NOT NULL,
    last_name     VARCHAR(40) NOT NULL,
    phone_number  NUMBER(10),
    email         VARCHAR(100),
    region_id     NUMBER,
    employee_id   NUMBER
);

CREATE TABLE accounts (
    quote_id        NUMBER NOT NULL
        CONSTRAINT apk PRIMARY KEY,
    employee_id     NUMBER NOT NULL,
    customer_id     NUMBER NOT NULL,
    yearly_payment  VARCHAR(1) NOT NULL,
    discount        NUMBER(10, 2)
        CONSTRAINT dchk CHECK ( discount BETWEEN 0 AND 100 ),
    number_agents   NUMBER NOT NULL,
    offer_accepted  VARCHAR(1),
    product_id      NUMBER NOT NULL
);

ALTER TABLE customer
    ADD CONSTRAINT rfk FOREIGN KEY ( region_id )
        REFERENCES region ( region_id );

ALTER TABLE customer
    ADD CONSTRAINT efk FOREIGN KEY ( employee_id )
        REFERENCES sales ( employee_id );

ALTER TABLE sales
    ADD CONSTRAINT srfk FOREIGN KEY ( region_id )
        REFERENCES region ( region_id );

ALTER TABLE billing
    ADD CONSTRAINT bafk FOREIGN KEY ( quote_id )
        REFERENCES accounts ( quote_id );

ALTER TABLE accounts
    ADD CONSTRAINT aefk FOREIGN KEY ( employee_id )
        REFERENCES sales ( employee_id );

ALTER TABLE accounts
    ADD CONSTRAINT acfk FOREIGN KEY ( customer_id )
        REFERENCES customer ( customer_id );

ALTER TABLE accounts
    ADD CONSTRAINT apfk FOREIGN KEY ( product_id )
        REFERENCES product ( product_id );

ALTER TABLE product_sales
    ADD CONSTRAINT pspfk FOREIGN KEY ( product_id )
        REFERENCES product ( product_id );

ALTER TABLE product_sales
    ADD CONSTRAINT pssfk FOREIGN KEY ( employee_id )
        REFERENCES sales ( employee_id );
        
-- Region Table        
--Row 1
insert into Region (region_id,region) values (2000000001,'APAC');
--Row 2
insert into Region (region_id,region) values (2000000002,'India');
--Row 3
insert into Region (region_id,region) values (2000000003,'MEnA');
--Row 4
insert into Region (region_id,region) values (2000000004,'Europe');
--Row 5
insert into Region (region_id,region) values (2000000005,'Americas');  

--Sales

--Row 1
INSERT INTO SALES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, PHONE_NUMBER, EMAIL, REGION_ID) VALUES (1000000001,'John','Smith',6314655173,'JohnSmith@gmail.com',2000000001);
--Row 2
INSERT INTO SALES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, PHONE_NUMBER, EMAIL, REGION_ID) VALUES (1000000002,'Jeff','Johnson',6314656418,'JeffJohnson@gmail.com',2000000005);
--Row 3
INSERT INTO SALES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, PHONE_NUMBER, EMAIL, REGION_ID) VALUES (1000000003,'Steave','William',6314488218,'SteaveWilliam@gmail.com',2000000003);
--Row 4
INSERT INTO SALES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, PHONE_NUMBER, EMAIL, REGION_ID) VALUES (1000000004,'Alex','Miller',6311583484,'AlexMiller@gmail.com',2000000004);
--Row 5
INSERT INTO SALES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, PHONE_NUMBER, EMAIL, REGION_ID) VALUES (1000000005,'Chris','Joe',6314657868,'ChrisJoe@gmail.com',2000000005);
--Row 6
INSERT INTO SALES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, PHONE_NUMBER, EMAIL, REGION_ID) VALUES (1000000006,'Sid','Dav',6314155378,'SidDav@gmail.com',2000000001);
--Row 7
INSERT INTO SALES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, PHONE_NUMBER, EMAIL, REGION_ID) VALUES (1000000007,'Mike','Peter',6314655745,'MikePeter@gmail.com',2000000002);
--Row 8
INSERT INTO SALES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, PHONE_NUMBER, EMAIL, REGION_ID) VALUES (1000000008,'Kerry','Parker',6316881845,'KerryParker@gmail.com',2000000004);
--Row 9
INSERT INTO SALES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, PHONE_NUMBER, EMAIL, REGION_ID) VALUES (1000000009,'Cloe','Rickey',6314546118,'CloeRickey@gmail.com',2000000004);
--Row 10
INSERT INTO SALES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, PHONE_NUMBER, EMAIL, REGION_ID) VALUES (1000000010,'Ken','Carlo',6314789222,'KenCarlo@gmail.com',2000000002);

--Customer Table

--Row 1
INSERT INTO CUSTOMER (CUSTOMER_ID, FIRST_NAME, LAST_NAME, PHONE_NUMBER, EMAIL, REGION_ID, EMPLOYEE_ID) VALUES (5000000001,'Mike','Tyson',6318031799,'MikeTyson@gmail.com',2000000001,1000000001);
--Row 2
INSERT INTO CUSTOMER (CUSTOMER_ID, FIRST_NAME, LAST_NAME, PHONE_NUMBER, EMAIL, REGION_ID, EMPLOYEE_ID) VALUES (5000000002,'Vann','Hussen',6318841516,'VannHussen@gmail.com',2000000002,1000000002);
--Row 3
INSERT INTO CUSTOMER (CUSTOMER_ID, FIRST_NAME, LAST_NAME, PHONE_NUMBER, EMAIL, REGION_ID, EMPLOYEE_ID) VALUES (5000000003,'Cruise','William',6316228594,'CruiseWilliam@gmail.com',2000000003,1000000003);
--Row 4
INSERT INTO CUSTOMER (CUSTOMER_ID, FIRST_NAME, LAST_NAME, PHONE_NUMBER, EMAIL, REGION_ID, EMPLOYEE_ID) VALUES (5000000004,'Don','Terra',6313479332,'DonTerra@gmail.com',2000000004,1000000004);
--Row 5
INSERT INTO CUSTOMER (CUSTOMER_ID, FIRST_NAME, LAST_NAME, PHONE_NUMBER, EMAIL, REGION_ID, EMPLOYEE_ID) VALUES (5000000005,'Ben','Jemin',6310230610,'BenJemin@gmail.com',2000000005,1000000005);
--Row 6
INSERT INTO CUSTOMER (CUSTOMER_ID, FIRST_NAME, LAST_NAME, PHONE_NUMBER, EMAIL, REGION_ID, EMPLOYEE_ID) VALUES (5000000006,'Ten','Won',6319546514,'TenWon@gmail.com',2000000004,1000000001);
--Row 7
INSERT INTO CUSTOMER (CUSTOMER_ID, FIRST_NAME, LAST_NAME, PHONE_NUMBER, EMAIL, REGION_ID, EMPLOYEE_ID) VALUES (5000000007,'Luke','Sie',6315358880,'LukeSie@gmail.com',2000000002,1000000001);
--Row 8
INSERT INTO CUSTOMER (CUSTOMER_ID, FIRST_NAME, LAST_NAME, PHONE_NUMBER, EMAIL, REGION_ID, EMPLOYEE_ID) VALUES (5000000008,'Jake','Lu',6316278568,'JakeLu@gmail.com',2000000003,1000000004);
--Row 9
INSERT INTO CUSTOMER (CUSTOMER_ID, FIRST_NAME, LAST_NAME, PHONE_NUMBER, EMAIL, REGION_ID, EMPLOYEE_ID) VALUES (5000000009,'John','Woo',6311410525,'JohnWoo@gmail.com',2000000002,1000000005);
--Row 10
INSERT INTO CUSTOMER (CUSTOMER_ID, FIRST_NAME, LAST_NAME, PHONE_NUMBER, EMAIL, REGION_ID, EMPLOYEE_ID) VALUES (5000000010,'Venn','Kelly',6313656068,'VennKelly@gmail.com',2000000003,1000000003);

--Product

--Row 1
insert into product (product_id,product_name,cost_per_agent) values (4000000001,'Desk',19);
--Row 2
insert into product (product_id,product_name,cost_per_agent) values (4000000002,'Chat',15);
--Row 3
insert into product (product_id,product_name,cost_per_agent) values (4000000003,'Caller',16);
--Row 4
insert into product (product_id,product_name,cost_per_agent) values (4000000004,'CRM',21);
--Row 5
insert into product (product_id,product_name,cost_per_agent) values (4000000005,'ITSM',25);

--Product Sales

--Row 1
INSERT INTO PRODUCT_SALES (SALES_PRODUCT_ID, PRODUCT_ID, EMPLOYEE_ID) VALUES (1,4000000001,1000000001);
--Row 2
INSERT INTO PRODUCT_SALES (SALES_PRODUCT_ID, PRODUCT_ID, EMPLOYEE_ID) VALUES (2,4000000005,1000000001);
--Row 3
INSERT INTO PRODUCT_SALES (SALES_PRODUCT_ID, PRODUCT_ID, EMPLOYEE_ID) VALUES (3,4000000003,1000000003);
--Row 4
INSERT INTO PRODUCT_SALES (SALES_PRODUCT_ID, PRODUCT_ID, EMPLOYEE_ID) VALUES (4,4000000004,1000000004);
--Row 5
INSERT INTO PRODUCT_SALES (SALES_PRODUCT_ID, PRODUCT_ID, EMPLOYEE_ID) VALUES (5,4000000005,1000000001);
--Row 6
INSERT INTO PRODUCT_SALES (SALES_PRODUCT_ID, PRODUCT_ID, EMPLOYEE_ID) VALUES (6,4000000002,1000000006);
--Row 7
INSERT INTO PRODUCT_SALES (SALES_PRODUCT_ID, PRODUCT_ID, EMPLOYEE_ID) VALUES (7,4000000003,1000000007);
--Row 8
INSERT INTO PRODUCT_SALES (SALES_PRODUCT_ID, PRODUCT_ID, EMPLOYEE_ID) VALUES (8,4000000005,1000000003);
--Row 9
INSERT INTO PRODUCT_SALES (SALES_PRODUCT_ID, PRODUCT_ID, EMPLOYEE_ID) VALUES (9,4000000001,1000000003);
--Row 10
INSERT INTO PRODUCT_SALES (SALES_PRODUCT_ID, PRODUCT_ID, EMPLOYEE_ID) VALUES (10,4000000004,1000000010);
--Row 11
INSERT INTO PRODUCT_SALES (SALES_PRODUCT_ID, PRODUCT_ID, EMPLOYEE_ID) VALUES (11,4000000005,1000000007);
--Row 12
INSERT INTO PRODUCT_SALES (SALES_PRODUCT_ID, PRODUCT_ID, EMPLOYEE_ID) VALUES (12,4000000002,1000000003);
--Row 13
INSERT INTO PRODUCT_SALES (SALES_PRODUCT_ID, PRODUCT_ID, EMPLOYEE_ID) VALUES (13,4000000003,1000000003);
--Row 14
INSERT INTO PRODUCT_SALES (SALES_PRODUCT_ID, PRODUCT_ID, EMPLOYEE_ID) VALUES (14,4000000005,1000000010);
--Row 15
INSERT INTO PRODUCT_SALES (SALES_PRODUCT_ID, PRODUCT_ID, EMPLOYEE_ID) VALUES (15,4000000001,1000000004);
--Row 16
INSERT INTO PRODUCT_SALES (SALES_PRODUCT_ID, PRODUCT_ID, EMPLOYEE_ID) VALUES (16,4000000004,1000000001);
--Row 17
INSERT INTO PRODUCT_SALES (SALES_PRODUCT_ID, PRODUCT_ID, EMPLOYEE_ID) VALUES (17,4000000005,1000000006);
--Row 18
INSERT INTO PRODUCT_SALES (SALES_PRODUCT_ID, PRODUCT_ID, EMPLOYEE_ID) VALUES (18,4000000003,1000000007);
--Row 19
INSERT INTO PRODUCT_SALES (SALES_PRODUCT_ID, PRODUCT_ID, EMPLOYEE_ID) VALUES (19,4000000004,1000000001);
--Row 20
INSERT INTO PRODUCT_SALES (SALES_PRODUCT_ID, PRODUCT_ID, EMPLOYEE_ID) VALUES (20,4000000005,1000000003);

--Accounts

--Row 1
INSERT INTO ACCOUNTS (QUOTE_ID, EMPLOYEE_ID, CUSTOMER_ID, YEARLY_PAYMENT, DISCOUNT, NUMBER_AGENTS, OFFER_ACCEPTED, PRODUCT_ID) VALUES (3000000001,1000000001,5000000001,'Y',6,5,'Y',4000000001);
--Row 2
INSERT INTO ACCOUNTS (QUOTE_ID, EMPLOYEE_ID, CUSTOMER_ID, YEARLY_PAYMENT, DISCOUNT, NUMBER_AGENTS, OFFER_ACCEPTED, PRODUCT_ID) VALUES (3000000002,1000000002,5000000002,'Y',14,6,'N',4000000002);
--Row 3
INSERT INTO ACCOUNTS (QUOTE_ID, EMPLOYEE_ID, CUSTOMER_ID, YEARLY_PAYMENT, DISCOUNT, NUMBER_AGENTS, OFFER_ACCEPTED, PRODUCT_ID) VALUES (3000000003,1000000003,5000000003,'N',9,3,'N',4000000003);
--Row 4
INSERT INTO ACCOUNTS (QUOTE_ID, EMPLOYEE_ID, CUSTOMER_ID, YEARLY_PAYMENT, DISCOUNT, NUMBER_AGENTS, OFFER_ACCEPTED, PRODUCT_ID) VALUES (3000000004,1000000004,5000000004,'N',15,8,'N',4000000004);
--Row 5
INSERT INTO ACCOUNTS (QUOTE_ID, EMPLOYEE_ID, CUSTOMER_ID, YEARLY_PAYMENT, DISCOUNT, NUMBER_AGENTS, OFFER_ACCEPTED, PRODUCT_ID) VALUES (3000000005,1000000005,5000000005,'Y',5,3,'Y',4000000005);
--Row 6
INSERT INTO ACCOUNTS (QUOTE_ID, EMPLOYEE_ID, CUSTOMER_ID, YEARLY_PAYMENT, DISCOUNT, NUMBER_AGENTS, OFFER_ACCEPTED, PRODUCT_ID) VALUES (3000000006,1000000003,5000000006,'N',34,5,'Y',4000000001);
--Row 7
INSERT INTO ACCOUNTS (QUOTE_ID, EMPLOYEE_ID, CUSTOMER_ID, YEARLY_PAYMENT, DISCOUNT, NUMBER_AGENTS, OFFER_ACCEPTED, PRODUCT_ID) VALUES (3000000007,1000000004,5000000004,'Y',35,5,'Y',4000000002);
--Row 8
INSERT INTO ACCOUNTS (QUOTE_ID, EMPLOYEE_ID, CUSTOMER_ID, YEARLY_PAYMENT, DISCOUNT, NUMBER_AGENTS, OFFER_ACCEPTED, PRODUCT_ID) VALUES (3000000008,1000000005,5000000008,'Y',4,3,'N',4000000004);
--Row 9
INSERT INTO ACCOUNTS (QUOTE_ID, EMPLOYEE_ID, CUSTOMER_ID, YEARLY_PAYMENT, DISCOUNT, NUMBER_AGENTS, OFFER_ACCEPTED, PRODUCT_ID) VALUES (3000000009,1000000001,5000000009,'Y',30,8,'Y',4000000004);
--Row 10
INSERT INTO ACCOUNTS (QUOTE_ID, EMPLOYEE_ID, CUSTOMER_ID, YEARLY_PAYMENT, DISCOUNT, NUMBER_AGENTS, OFFER_ACCEPTED, PRODUCT_ID) VALUES (3000000010,1000000002,5000000010,'Y',28,6,'Y',4000000002);

--Billing

--Row 1
INSERT INTO BILLING (INVOICE_ID, QUOTE_ID) VALUES (7000000001,3000000001);
--Row 2
INSERT INTO BILLING (INVOICE_ID, QUOTE_ID) VALUES (7000000002,3000000002);
--Row 3
INSERT INTO BILLING (INVOICE_ID, QUOTE_ID) VALUES (7000000003,3000000003);
--Row 4
INSERT INTO BILLING (INVOICE_ID, QUOTE_ID) VALUES (7000000004,3000000004);
--Row 5
INSERT INTO BILLING (INVOICE_ID, QUOTE_ID) VALUES (7000000005,3000000005);
--Row 6
INSERT INTO BILLING (INVOICE_ID, QUOTE_ID) VALUES (7000000006,3000000006);
--Row 7
INSERT INTO BILLING (INVOICE_ID, QUOTE_ID) VALUES (7000000007,3000000007);
--Row 8
INSERT INTO BILLING (INVOICE_ID, QUOTE_ID) VALUES (7000000008,3000000008);
--Row 9
INSERT INTO BILLING (INVOICE_ID, QUOTE_ID) VALUES (7000000009,3000000009);
--Row 10
INSERT INTO BILLING (INVOICE_ID, QUOTE_ID) VALUES (7000000010,3000000010);


/*Query 1 * Which region has most customers*/
WITH customer_region AS (
    SELECT
        b.region                   AS region,
        COUNT(a.customer_id)       AS total
    FROM
             customer a
        JOIN region b ON a.region_id = b.region_id
    GROUP BY
        b.region
)
SELECT
    region,
    total
FROM
    customer_region
WHERE
    total = (
        SELECT
            MAX(total)
        FROM
            customer_region
    );

/*Query 2* What is the highest and lowest discount offered for each product*/
SELECT
    b.product_name AS product,
    MAX(discount),
    MIN(discount)
FROM
         accounts a
    JOIN product b ON a.product_id = b.product_id
GROUP BY
    b.product_name;

/*Query 3 Which sales has the highest conversion ratio (Total number os offers accepted to total number of offers quoted */
WITH sales_conversion AS (
    SELECT
        b.last_name,
        ( COUNT(
            CASE
                WHEN lower(a.offer_accepted) = 'y' THEN
                    1
            END
        ) / COUNT(*) ) * 100 AS percent
    FROM
             accounts a
        JOIN sales b ON a.employee_id = b.employee_id
    GROUP BY
        b.last_name
)
SELECT
    *
FROM
    sales_conversion
WHERE
    percent = (
        SELECT
            MAX(percent)
        FROM
            sales_conversion
    );

/* Query 4* How much revenue each region is generating per employee working in the region */
SELECT
    b.region,
    a.last_name,
    SUM(c.number_agents * d.cost_per_agent) AS total_revenue
FROM
         sales a
    JOIN region    b ON a.region_id = b.region_id
    JOIN accounts  c ON a.employee_id = c.employee_id
    JOIN product   d ON c.product_id = d.product_id
GROUP BY
    b.region,
    a.last_name
ORDER BY
    total_revenue DESC;

/* Query 5* Retrieve the data of customers which gives total customers by product, region and product by region */
SELECT
    c.region                  AS region,
    d.product_name            AS product,
    COUNT(d.product_id)       AS total_count
FROM
         customer a
    JOIN accounts  b ON a.customer_id = b.customer_id
    JOIN region    c ON a.region_id = c.region_id
    JOIN product   d ON b.product_id = d.product_id
WHERE
    lower(b.offer_accepted) = 'y'
GROUP BY
    GROUPING SETS ( ( c.region,
                      d.product_name ), ( c.region ),
                                        ( d.product_name ) );